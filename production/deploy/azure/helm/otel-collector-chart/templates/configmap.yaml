# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Resource to create a OTel collector Kubernetes ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: "otel-collector-config"
  namespace: {{ .Values.namespace | default .Release.Namespace }}
data:
  "otel-collector-config.yaml": |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: "0.0.0.0:{{ .Values.otel_grpc_port }}"
    processors:
      batch/traces:
        timeout: 1s
        send_batch_size: 50
      batch/metrics:
        timeout: 60s
      batch/logs:
        timeout: 60s
      filter/drop_event:
        error_mode: ignore
        logs:
          log_record:
            - 'attributes["ps_tee_log_type"] == "event_message"'
      filter/drop_non_event:
        error_mode: ignore
        logs:
          log_record:
            - 'attributes["ps_tee_log_type"] != "event_message"'
    extensions:
      health_check:
    exporters:
      debug:
        verbosity: detailed
      azuremonitor/otel:
        connection_string: "{{ .Values.application_insights_otel_connection_string }}"
        spaneventsenabled: true
      prometheus:
        endpoint: "0.0.0.0:8889"
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch/traces]
          exporters: [azuremonitor/otel,debug]
        metrics:
          receivers: [otlp]
          processors: [batch/metrics]
          exporters: [azuremonitor/otel, prometheus, debug]
        logs:
          receivers: [otlp]
          processors: [batch/logs,filter/drop_event,filter/drop_non_event]
          exporters: [azuremonitor/otel,debug]
